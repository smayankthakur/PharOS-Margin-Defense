generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  OWNER
  SALES
  OPS
  VIEWER
}

enum AlertType {
  MAP
  MRP
  UNDERCUT
  DEAD_STOCK
}

enum Severity {
  LOW
  MED
  HIGH
}

enum AlertStatus {
  OPEN
  ACK
  RESOLVED
}

enum TaskStatus {
  OPEN
  IN_PROGRESS
  DONE
}

model Tenant {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  createdAt DateTime @default(now())

  users       User[]
  skus        Sku[]
  dealers     Dealer[]
  sales       SaleRow[]
  competitors Competitor[]
  snapshots   CompetitorSnapshot[]
  alerts      Alert[]
  tasks       Task[]
}

model User {
  id           String   @id @default(cuid())
  tenantId     String
  email        String
  passwordHash String
  role         Role
  createdAt    DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id])
  tasks  Task[] @relation("TaskAssignee")

  @@unique([tenantId, email])
  @@index([tenantId])
}

model Sku {
  id        String   @id @default(cuid())
  tenantId  String
  skuCode   String
  name      String
  mrp       Float
  map       Float
  cost      Float
  onHandQty Int
  createdAt DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id])

  saleRows   SaleRow[]
  snapshots  CompetitorSnapshot[]
  alerts     Alert[]

  @@index([tenantId])
  @@index([tenantId, skuCode])
}

model Dealer {
  id        String   @id @default(cuid())
  tenantId  String
  name      String
  channel   String
  createdAt DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id])

  saleRows SaleRow[]
  alerts   Alert[]

  @@index([tenantId])
}

model SaleRow {
  id        String   @id @default(cuid())
  tenantId  String
  skuId     String
  dealerId  String
  soldPrice Float
  qty       Int
  soldAt    DateTime
  orderRef  String

  tenant Tenant @relation(fields: [tenantId], references: [id])
  sku    Sku    @relation(fields: [skuId], references: [id])
  dealer Dealer @relation(fields: [dealerId], references: [id])

  @@index([tenantId])
  @@index([tenantId, soldAt])
  @@index([tenantId, skuId])
}

model Competitor {
  id        String   @id @default(cuid())
  tenantId  String
  name      String
  createdAt DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id])

  snapshots CompetitorSnapshot[]
  alerts    Alert[]

  @@index([tenantId])
}

model CompetitorSnapshot {
  id           String   @id @default(cuid())
  tenantId     String
  competitorId String
  skuId        String
  price        Float
  capturedAt   DateTime
  url          String

  tenant     Tenant     @relation(fields: [tenantId], references: [id])
  competitor Competitor @relation(fields: [competitorId], references: [id])
  sku        Sku        @relation(fields: [skuId], references: [id])

  @@index([tenantId])
  @@index([tenantId, capturedAt])
  @@index([tenantId, skuId])
}

model Alert {
  id           String      @id @default(cuid())
  tenantId     String
  type         AlertType
  skuId        String
  dealerId     String?
  competitorId String?
  severity     Severity
  impactAmount Float
  evidenceJson Json
  status       AlertStatus @default(OPEN)
  dedupeKey    String
  createdAt    DateTime    @default(now())

  tenant     Tenant      @relation(fields: [tenantId], references: [id])
  sku        Sku         @relation(fields: [skuId], references: [id])
  dealer     Dealer?     @relation(fields: [dealerId], references: [id])
  competitor Competitor? @relation(fields: [competitorId], references: [id])

  tasks Task[]

  @@index([tenantId])
  @@index([tenantId, createdAt])
  @@unique([tenantId, dedupeKey])
}

model Task {
  id             String     @id @default(cuid())
  tenantId       String
  alertId        String?
  title          String
  slaDueAt       DateTime
  assigneeUserId String?
  status         TaskStatus @default(OPEN)
  createdAt      DateTime   @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id])
  alert  Alert? @relation(fields: [alertId], references: [id])
  assignee User? @relation("TaskAssignee", fields: [assigneeUserId], references: [id])

  @@index([tenantId])
}
